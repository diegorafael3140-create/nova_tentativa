<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Revis√£o PRF App</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3b82f6"/>
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
/* Estilos Gerais (CSS completo) */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%); min-height: 100vh; color: #f5f5f5; }
.container { max-width: 1000px; margin: 0 auto; padding: 20px; }
.header { text-align: center; color: white; margin-bottom: 30px; padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 15px; }
.header h1 { font-size: 2.8em; margin-bottom: 10px; font-weight: 300; }
.card { background: linear-gradient(145deg, #f8f9fa, #e9ecef); color: #333; border-radius: 20px; padding: 35px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); margin-bottom: 25px; border: 1px solid #dee2e6; }
.screen { display: none; }
.screen.active { display: block; }
.btn { background: linear-gradient(145deg, #3b82f6, #2563eb); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 16px; cursor: pointer; margin: 5px; transition: all 0.3s; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
.btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
.btn:disabled { background: #6c757d; cursor: not-allowed; }
.btn-success { background: linear-gradient(145deg, #22c55e, #16a34a); }
.btn-danger { background: linear-gradient(145deg, #ef4444, #b91c1c); }
.btn-small-danger { font-size: 12px; padding: 5px 10px; background: linear-gradient(145deg, #ef4444, #b91c1c); border-radius: 5px; }
.btn-warning-small { background: linear-gradient(145deg, #facc15, #eab308); color: #333; font-size: 14px; padding: 8px 16px; display: inline-block; text-decoration: none; border-radius: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; border: none; cursor: pointer; transition: all 0.3s; }
.btn-warning-small:hover { transform: translateY(-2px); }
.form-group { margin-bottom: 25px; }
.form-group label { display: block; margin-bottom: 10px; font-weight: 600; color: #495057; }
.form-group select, .form-group input, .form-group textarea { width: 100%; padding: 15px; border: 2px solid #ced4da; border-radius: 10px; font-size: 16px; }
.form-group textarea { min-height: 150px; line-height: 1.5; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; margin-bottom: 25px; }
.stat-card { background: linear-gradient(145deg, #333, #555); color: white; padding: 25px; border-radius: 15px; text-align: center; }
.stat-number { font-size: 2.8em; font-weight: 300; margin-bottom: 8px; }
.stat-label { text-transform: uppercase; letter-spacing: 1px; font-size: 0.9em; }
#pending-list, #discipline-management-list { list-style-type: none; padding: 0; }
#pending-list li, #discipline-management-list li { background-color: #f8f9fa; padding: 12px 18px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-weight: 500; border: 1px solid #e9ecef; }
.list-container { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }
.list-container h3 { margin-bottom: 15px; color: #333; }
.difficulty-buttons { margin-top: 20px; text-align: center; }
.goal-item { display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: center; margin-bottom: 15px; }
.goal-item label { flex-grow: 1; font-weight: bold; }
.goal-item input, .goal-item select { width: 120px; text-align: center; padding: 8px; }
.suggestion-box { background-color: #e3f2fd; color: #1e88e5; border: 1px solid #90caf9; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center; font-weight: 500; }
.stats-filter-container { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
.stats-filter-container label { font-weight: bold; }
.stats-filter-container select { padding: 8px; border-radius: 8px; border: 2px solid #ced4da; }
.accordion { padding: 10px 15px; font-size: 16px; margin-bottom: 5px; }
.panel { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background-color: white; padding: 10px; border-radius: 0 0 10px 10px; margin-bottom: 5px; color: #333; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
.subject-stat-item { background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #e9ecef; }
.subject-stat-item h4 { font-size: 1em; margin-bottom: 5px; }
.evolution-chart { background: #f0f0f0; border-radius: 5px; padding: 5px; }
.evolution-chart .bar { height: 16px; line-height: 16px; color: white; font-size: 11px; text-align: right; padding-right: 5px; border-radius: 3px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; font-weight: bold; }
.bar-excellent { background-color: #22c55e; } .bar-good { background-color: #a3e635; color: #333; } .bar-regular { background-color: #facc15; color: #333; } .bar-weak { background-color: #ef4444; }
.activity-monitor { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }
.streak-counter { text-align: center; font-size: 1.8em; font-weight: bold; margin-bottom: 20px; color: #ff9800; }
.heatmap { display: grid; grid-template-rows: repeat(7, 1fr); grid-auto-flow: column; gap: 4px; overflow-x: auto; padding-bottom: 10px; }
.heatmap-day { width: 15px; height: 15px; background-color: #ebedf0; border-radius: 3px; }
.heatmap-day[data-level="1"] { background-color: #9be9a8; } .heatmap-day[data-level="2"] { background-color: #40c463; } .heatmap-day[data-level="3"] { background-color: #30a14e; } .heatmap-day[data-level="4"] { background-color: #216e39; }
.heatmap-months { display: flex; justify-content: space-around; font-size: 12px; margin-bottom: 5px; }
.progress-bar-container { width: 100%; height: 20px; background-color: #e0e0e0; border-radius: 10px; overflow: hidden; position: relative; }
.progress-bar-fill { height: 100%; background-color: #3b82f6; border-radius: 10px; transition: width 0.5s ease; }
.progress-bar-label { position: absolute; width: 100%; text-align: center; line-height: 20px; color: #333; font-weight: bold; font-size: 12px; }
.goal-marker { position: absolute; top: 0; bottom: 0; width: 2px; background-color: #ef4444; }
.subject-actions button { font-size: 12px; padding: 5px 10px; margin-top: 5px; background: #ddd; border: 1px solid #ccc; border-radius: 5px; cursor: pointer;}
.subject-actions button:hover { background: #ccc; }
#history-detail-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
#history-detail-table th, #history-detail-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
#history-detail-table th { background-color: #f2f2f2; }
.add-discipline-form { display: flex; gap: 10px; margin-bottom: 20px; }
.add-discipline-form input { flex-grow: 1; }
</style>
</head>
<body>
<h1>TESTE: ATUALIZA√á√ÉO BEM-SUCEDIDA!</h1>
<div class="container">
  <div class="header"><h1>REVIS√ÉO ESPA√áADA POR QUEST√ïES</h1><p>Vers√£o PWA</p></div>
  <div id="dashboard" class="screen active card">
    <h2>Dashboard</h2>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-number" id="pending-count">0</div><div class="stat-label">Revis√µes Pendentes</div></div>
      <div class="stat-card"><div class="stat-number" id="total-disciplines">0</div><div class="stat-label">Disciplinas</div></div>
      <div class="stat-card"><div class="stat-number" id="avg-percentage">0%</div><div class="stat-label">M√©dia Geral</div></div>
    </div>
    <div class="nav-buttons" style="text-align: center;">
      <button class="btn" onclick="showScreen('add-subject')">Adicionar Assunto</button>
      <button class="btn btn-success" id="start-review-btn" onclick="startReview()">Come√ßar Revis√£o</button>
      <button class="btn" onclick="showScreen('statistics')">Estat√≠sticas</button>
      <button class="btn" onclick="showScreen('goals')">Metas e Pesos</button>
      <button class="btn" onclick="showScreen('manage-disciplines')">Disciplinas</button>
    </div>
    <div class="activity-monitor">
        <div id="streak-counter" class="streak-counter"></div>
        <div id="heatmap-months" class="heatmap-months"></div>
        <div id="heatmap" class="heatmap"></div>
    </div>
    <div id="pending-list-container" class="list-container">
        <h3>Revis√µes Pendentes (Priorizadas)</h3>
        <ul id="pending-list"></ul>
    </div>
  </div>
  <div id="add-subject" class="screen card">
    <h2>Adicionar Assunto</h2>
    <div class="form-group"><label>Disciplina:</label><select id="discipline-select"></select></div>
    <div class="form-group"><label>Assunto:</label><input type="text" id="subject-input" /></div>
    <div class="form-group"><label>Link do Banco de Quest√µes (Opcional):</label><input type="url" id="question-bank-link" placeholder="https://..." /></div>
    <div class="nav-buttons"><button class="btn" onclick="showScreen('dashboard')">Voltar</button><button class="btn btn-success" onclick="addSubject()">Adicionar</button></div>
  </div>
  <div id="review" class="screen card">
    <h2>Revis√£o</h2>
    <p><strong>Disciplina:</strong> <span id="review-discipline"></span></p>
    <p><strong>Assunto:</strong> <span id="review-subject"></span></p>
    <div id="question-bank-section" style="margin-bottom: 20px; display:none;"><a href="#" id="question-bank-button" target="_blank" class="btn-warning-small">Abrir Banco de Quest√µes</a></div>
    <div class="suggestion-box">Sugest√£o: Resolva de 15 a 30 quest√µes para esta revis√£o.</div>
    <div class="form-group"><label>Total de Quest√µes Respondidas:</label><input type="number" id="total-questions" min="1"/></div>
    <div class="form-group"><label>Quest√µes Acertadas:</label><input type="number" id="correct-questions" min="0"/></div>
    <div id="percentage-display" style="text-align:center; font-size: 1.5em; font-weight: bold; margin-bottom: 20px; display:none;"></div>
    <div class="form-group"><label>Caderno de Erros / Bizus:</label><textarea id="error-notebook" placeholder="Anote aqui os principais aprendizados..."></textarea></div>
    <div id="difficulty-buttons" class="difficulty-buttons" style="display:none;">
        <h3>Como foi essa revis√£o?</h3>
        <button class="btn btn-danger" onclick="confirmReview('dificil')">Dif√≠cil</button>
        <button class="btn btn-success" onclick="confirmReview('normal')">Normal</button>
        <button class="btn btn-success" onclick="confirmReview('facil')">F√°cil</button>
    </div>
    <div class="nav-buttons" style="text-align:center;"><button class="btn" onclick="showScreen('dashboard')">Cancelar</button></div>
  </div>
  <div id="statistics" class="screen card">
    <h2>Estat√≠sticas</h2>
    <div class="stats-filter-container">
        <label for="stats-sort-filter">Ordenar por:</label>
        <select id="stats-sort-filter">
            <option value="padrao">Padr√£o (Alfab√©tica)</option>
            <option value="pior">Pior Desempenho</option>
            <option value="melhor">Melhor Desempenho</option>
        </select>
    </div>
    <div id="stats-container"></div>
    <div class="nav-buttons"><button class="btn" onclick="showScreen('dashboard')">Voltar</button></div>
  </div>
  <div id="goals" class="screen card">
    <h2>Metas e Prioridades</h2>
    <p>Defina uma meta de acerto e uma prioridade de revis√£o para cada disciplina.</p>
    <div id="goals-list" style="margin-top: 20px;"></div>
    <div class="nav-buttons">
        <button class="btn" onclick="showScreen('dashboard')">Voltar</button>
        <button class="btn btn-success" onclick="saveGoals()">Salvar</button>
    </div>
  </div>
  <div id="edit-subject" class="screen card">
    <h2>Editar Assunto</h2>
    <div class="form-group"><label>Disciplina:</label><select id="edit-discipline-select"></select></div>
    <div class="form-group"><label>Assunto:</label><input type="text" id="edit-subject-input" /></div>
    <div class="form-group"><label>Link do Banco de Quest√µes (Opcional):</label><input type="url" id="edit-question-bank-link" /></div>
    <div class="nav-buttons">
        <button class="btn" onclick="showScreen('statistics')">Cancelar</button>
        <button class="btn btn-success" onclick="saveSubjectChanges()">Salvar Altera√ß√µes</button>
    </div>
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center;">
        <button class="btn btn-danger" onclick="deleteSubject()">Excluir Assunto</button>
    </div>
  </div>
  <div id="history-detail" class="screen card">
    <h2 id="history-detail-title">Hist√≥rico do Assunto</h2>
    <div id="history-detail-content"></div>
    <div class="nav-buttons">
        <button class="btn" onclick="showScreen('statistics')">Voltar</button>
    </div>
  </div>
  <div id="manage-disciplines" class="screen card">
    <h2>Gerenciar Disciplinas</h2>
    <div class="add-discipline-form">
        <input type="text" id="new-discipline-input" placeholder="Nome da nova disciplina">
        <button class="btn btn-success" onclick="addDiscipline()">Adicionar</button>
    </div>
    <div id="discipline-management-list-container" class="list-container">
        <h3>Disciplinas Atuais</h3>
        <ul id="discipline-management-list"></ul>
    </div>
    <div class="nav-buttons">
        <button class="btn" onclick="showScreen('dashboard')">Voltar</button>
    </div>
  </div>
</div>

<script>
const STORAGE_KEY = 'revisao-espacada-v1';

class PRFSystem {
    constructor() {
        let currentData = null;
        const oldKey = 'prf-subjects-v3.9';
        
        try {
            currentData = JSON.parse(localStorage.getItem(STORAGE_KEY));
            const oldData = localStorage.getItem(oldKey);

            if (!currentData && oldData) {
                currentData = JSON.parse(oldData);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(currentData));
            }
        } catch (e) {
            console.error("Erro ao carregar dados:", e);
            currentData = [];
        }
        
        this.subjects = currentData || [];
        
        // **********************************************
        // L√ìGICA DE PR√â-CADASTRO DOS ASSUNTOS
        // **********************************************
        if (this.subjects.length === 0) {
            this.subjects = getInitialSubjects();
            this.save();
            console.log('Assuntos iniciais pr√©-cadastrados.');
        }

        this.disciplines = this.getDisciplinesFromStorage();
        this.currentReviewIndex = null;
        this.currentSort = 'padrao';
        this.currentEditingId = null;
        this.setupListeners();
        this.updateDashboard();
        this.populateDisciplineSelects();
    }
    
    // O resto da classe PRFSystem (getDisciplinesFromStorage, populateDisciplineSelects, 
    // setupListeners, save, updateDashboard, addSubject, startReview, etc.) 
    // permanece exatamente o mesmo que voc√™ forneceu/pediu, com os m√©todos aqui:

    getDisciplinesFromStorage() {
        const disciplineSet = new Set();
        this.subjects.forEach(s => disciplineSet.add(s.discipline));
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('discipline-')) {
                disciplineSet.add(key.replace('discipline-', ''));
            }
        });
        return [...disciplineSet].sort().map(d => {
            const stored = JSON.parse(localStorage.getItem(`discipline-${d}`));
            return { name: d, goal: stored?.goal || null, weight: stored?.weight || 'media' };
        });
    }
    populateDisciplineSelects() {
        const disciplineOptions = this.disciplines.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
        document.getElementById('discipline-select').innerHTML = `<option value="">Selecione...</option>${disciplineOptions}`;
        document.getElementById('edit-discipline-select').innerHTML = disciplineOptions;
    }
    setupListeners() {
        document.getElementById('total-questions').addEventListener('input', () => this.calculatePercentage());
        document.getElementById('correct-questions').addEventListener('input', () => this.calculatePercentage());
        document.getElementById('stats-sort-filter').addEventListener('change', (e) => {
            this.currentSort = e.target.value;
            this.renderStatistics();
        });
    }
    save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(this.subjects));
        this.disciplines.forEach(d => {
            localStorage.setItem(`discipline-${d.name}`, JSON.stringify({ goal: d.goal, weight: d.weight }));
        });
    }
    updateDashboard() {
        const now = new Date();
        let pendingSubjects = this.subjects.filter(s => new Date(s.due) <= now);
        const weightMap = { 'alta': 1, 'media': 2, 'baixa': 3 };
        pendingSubjects.sort((a, b) => {
            const discA = this.disciplines.find(d => d.name === a.discipline);
            const discB = this.disciplines.find(d => d.name === b.discipline);
            const weightA = weightMap[discA?.weight || 'media'];
            const weightB = weightMap[discB?.weight || 'media'];
            if (weightA !== weightB) return weightA - weightB;
            return new Date(a.due) - new Date(b.due);
        });
        document.getElementById('pending-count').textContent = pendingSubjects.length;
        document.getElementById('total-disciplines').textContent = this.disciplines.length;
        const subjectsWithHistory = this.subjects.filter(s => s.history.length > 0);
        const avg = subjectsWithHistory.length > 0 ? Math.round(subjectsWithHistory.reduce((acc, s) => acc + s.history.at(-1).percentage, 0) / subjectsWithHistory.length) : 0;
        document.getElementById('avg-percentage').textContent = avg + '%';
        const startReviewBtn = document.getElementById('start-review-btn');
        if (pendingSubjects.length > 0) {
            startReviewBtn.innerHTML = `Revisar: <strong style="display: block; font-size: 0.8em;">${pendingSubjects[0].subject}</strong>`;
            startReviewBtn.disabled = false;
        } else {
            startReviewBtn.innerHTML = 'Nenhuma Revis√£o';
            startReviewBtn.disabled = true;
        }
        this.renderList(document.getElementById('pending-list'), pendingSubjects, 'Nenhuma revis√£o pendente!');
        this.renderActivityMonitor();
    }
    addSubject() {
        const discipline = document.getElementById('discipline-select').value.trim();
        const subject = document.getElementById('subject-input').value.trim().toUpperCase();
        const link = document.getElementById('question-bank-link').value.trim();
        if (!discipline || !subject) return alert('Disciplina e Assunto s√£o obrigat√≥rios!');
        if (this.subjects.find(s => s.discipline === discipline && s.subject === subject)) return alert('Este assunto j√° existe!');
        this.subjects.push({
            id: Date.now(), discipline, subject, questionBankLink: link, notebook: '', reps: 0,
            due: new Date(), history: [], interval: 1, easeFactor: 2.5
        });
        if (!this.disciplines.find(d => d.name === discipline)) {
            this.disciplines.push({ name: discipline, goal: null, weight: 'media' });
        }
        this.save(); this.updateDashboard(); this.populateDisciplineSelects(); this.showScreen('dashboard');
        document.getElementById('subject-input').value = '';
        document.getElementById('question-bank-link').value = '';
        document.getElementById('discipline-select').value = '';
    }
    startReview() {
        const now = new Date();
        let pendingSubjects = this.subjects.filter(s => new Date(s.due) <= now);
        if (pendingSubjects.length === 0) return alert('N√£o h√° revis√µes pendentes no momento!');
        const weightMap = { 'alta': 1, 'media': 2, 'baixa': 3 };
        pendingSubjects.sort((a, b) => {
            const discA = this.disciplines.find(d => d.name === a.discipline);
            const discB = this.disciplines.find(d => d.name === b.discipline);
            const weightA = weightMap[discA?.weight || 'media'];
            const weightB = weightMap[discB?.weight || 'media'];
            if (weightA !== weightB) return weightA - weightB;
            return new Date(a.due) - new Date(b.due);
        });
        const subjectToReview = pendingSubjects[0];
        this.currentReviewIndex = this.subjects.findIndex(s => s.id === subjectToReview.id);
        const s = this.subjects[this.currentReviewIndex];
        document.getElementById('review-discipline').textContent = s.discipline;
        document.getElementById('review-subject').textContent = s.subject;
        const qbSection = document.getElementById('question-bank-section');
        const qbButton = document.getElementById('question-bank-button');
        if (s.questionBankLink) { qbButton.href = s.questionBankLink; qbSection.style.display = 'block'; }
        else { qbSection.style.display = 'none'; }
        document.getElementById('error-notebook').value = s.notebook || '';
        document.getElementById('total-questions').value = '';
        document.getElementById('correct-questions').value = '';
        document.getElementById('percentage-display').style.display = 'none';
        document.getElementById('difficulty-buttons').style.display = 'none';
        this.showScreen('review');
    }
    calculatePercentage() {
        const total = parseInt(document.getElementById('total-questions').value);
        const correct = parseInt(document.getElementById('correct-questions').value);
        const percDisplay = document.getElementById('percentage-display');
        const diffButtons = document.getElementById('difficulty-buttons');
        if (isNaN(total) || isNaN(correct) || total <= 0 || correct < 0 || correct > total) {
            percDisplay.style.display = 'none'; diffButtons.style.display = 'none'; return;
        }
        const perc = Math.round((correct / total) * 100);
        percDisplay.textContent = `Aproveitamento: ${perc}%`;
        percDisplay.style.display = 'block'; diffButtons.style.display = 'block';
    }
    confirmReview(difficulty) {
        if (!confirm("Tem certeza de que deseja salvar esta revis√£o?")) { return; }
        const total = parseInt(document.getElementById('total-questions').value);
        const correct = parseInt(document.getElementById('correct-questions').value);
        if (isNaN(total) || isNaN(correct) || total <= 0 || correct < 0 || correct > total) return alert('Preencha os dados de acertos corretamente.');
        const subj = this.subjects[this.currentReviewIndex];
        const percentage = Math.round((correct / total) * 100);
        subj.notebook = document.getElementById('error-notebook').value;
        subj.history.push({ date: new Date().toISOString(), percentage, difficulty });
        subj.reps++;
        if (difficulty === 'dificil') { subj.easeFactor = Math.max(1.3, subj.easeFactor - 0.2); subj.interval = 1; }
        else if (difficulty === 'normal') { subj.interval = Math.ceil(subj.interval * subj.easeFactor * 0.9); }
        else if (difficulty === 'facil') { subj.easeFactor += 0.15; subj.interval = Math.ceil(subj.interval * subj.easeFactor * 1.1); }
        subj.due = new Date(Date.now() + subj.interval * 24 * 60 * 60 * 1000);
        this.save(); this.updateDashboard();
        alert(`Revis√£o registrada! Pr√≥xima revis√£o em ${subj.interval} dia(s).`);
        this.showScreen('dashboard');
    }
    renderGoals() {
        const goalsList = document.getElementById('goals-list');
        goalsList.innerHTML = '';
        this.disciplines.sort((a,b) => a.name.localeCompare(b.name)).forEach(d => {
            const item = document.createElement('div');
            item.className = 'goal-item';
            const subjectsInDisc = this.subjects.filter(s => s.discipline === d.name && s.history.length > 0);
            const avg = subjectsInDisc.length > 0 ? Math.round(subjectsInDisc.reduce((acc, s) => acc + s.history.at(-1).percentage, 0) / subjectsInDisc.length) : 0;
            item.innerHTML = `
                <div>
                    <label for="goal-${d.name}">${d.name}</label>
                    <div class="progress-bar-container" title="M√©dia: ${avg}%">
                        <div class="progress-bar-label">${avg}%</div>
                        <div class="progress-bar-fill" style="width: ${avg}%;"></div>
                        ${d.goal ? `<div class="goal-marker" style="left: ${d.goal}%;" title="Meta: ${d.goal}%"></div>` : ''}
                    </div>
                </div>
                <input type="number" id="goal-${d.name}" min="0" max="100" placeholder="Meta %" value="${d.goal || ''}">
                <select id="weight-${d.name}">
                    <option value="alta" ${d.weight === 'alta' ? 'selected' : ''}>Alta Prioridade</option>
                    <option value="media" ${d.weight === 'media' ? 'selected' : ''}>M√©dia Prioridade</option>
                    <option value="baixa" ${d.weight === 'baixa' ? 'selected' : ''}>Baixa Prioridade</option>
                </select>
            `;
            goalsList.appendChild(item);
        });
    }
    saveGoals() {
        this.disciplines.forEach(d => {
            const goalValue = document.getElementById(`goal-${d.name}`).value;
            const weightValue = document.getElementById(`weight-${d.name}`).value;
            d.goal = goalValue ? parseInt(goalValue) : null;
            d.weight = weightValue;
        });
        this.save(); alert('Metas e Prioridades salvas com sucesso!');
        this.updateDashboard(); this.showScreen('dashboard');
    }
    renderStatistics() {
        const container = document.getElementById('stats-container');
        container.innerHTML = '';
        this.disciplines.sort((a,b) => a.name.localeCompare(b.name)).forEach(disc => {
            let subjectsInDisc = this.subjects.filter(s => s.discipline === disc.name);
            if (subjectsInDisc.length === 0) return;
            const lastPerc = (s) => s.history.length > 0 ? s.history.at(-1).percentage : -1;
            if (this.currentSort === 'melhor') { subjectsInDisc.sort((a, b) => lastPerc(b) - lastPerc(a)); }
            else if (this.currentSort === 'pior') { subjectsInDisc.sort((a, b) => lastPerc(a) - lastPerc(b)); }
            else { subjectsInDisc.sort((a,b) => a.subject.localeCompare(b.subject)); }
            const subjectsWithHistory = subjectsInDisc.filter(s => s.history.length > 0);
            let disciplineAvgText = "";
            if (subjectsWithHistory.length > 0) {
                const avg = Math.round(subjectsWithHistory.reduce((acc, s) => acc + lastPerc(s), 0) / subjectsWithHistory.length);
                disciplineAvgText = `(M√©dia: ${avg}% / Meta: ${disc.goal || '-'}%)`;
            } else { disciplineAvgText = `(Meta: ${disc.goal || '-'}%)`; }
            const acc = document.createElement('button');
            acc.className = 'accordion';
            acc.textContent = `${disc.name} ${disciplineAvgText}`;
            container.appendChild(acc);
            const panel = document.createElement('div');
            panel.className = 'panel';
            subjectsInDisc.forEach(subj => {
                const subjectContainer = document.createElement('div');
                subjectContainer.className = 'subject-stat-item';
                const subjectTitle = document.createElement('h4');
                subjectTitle.textContent = subj.subject;
                subjectContainer.appendChild(subjectTitle);
                if (subj.history.length > 0) {
                    const chart = document.createElement('div');
                    chart.className = 'evolution-chart';
                    subj.history.forEach(h => {
                        const bar = document.createElement('div');
                        bar.className = 'bar';
                        if (h.percentage >= 90) bar.classList.add('bar-excellent');
                        else if (h.percentage >= 80) bar.classList.add('bar-good');
                        else if (h.percentage >= 70) bar.classList.add('bar-regular');
                        else bar.classList.add('bar-weak');
                        bar.style.width = `${h.percentage}%`; bar.textContent = `${h.percentage}%`;
                        chart.appendChild(bar);
                    });
                    subjectContainer.appendChild(chart);
                } else {
                    const noData = document.createElement('p');
                    noData.textContent = 'Nenhuma revis√£o registrada.'; noData.style.fontSize = '12px';
                    subjectContainer.appendChild(noData);
                }
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'subject-actions';
                actionsDiv.innerHTML = `
                    <button onclick="showHistoryDetail(${subj.id})">Hist√≥rico</button>
                    <button onclick="showEditScreen(${subj.id})">Editar</button>
                `;
                subjectContainer.appendChild(actionsDiv);
                panel.appendChild(subjectContainer);
            });
            container.appendChild(panel);
            acc.addEventListener('click', function() {
                this.classList.toggle('active');
                const p = this.nextElementSibling;
                p.style.maxHeight = p.style.maxHeight ? null : p.scrollHeight + "px";
            });
        });
    }
    renderActivityMonitor() {
        const allDates = this.subjects.flatMap(s => s.history.map(h => h.date.substring(0, 10)));
        const countsByDate = allDates.reduce((acc, date) => { acc[date] = (acc[date] || 0) + 1; return acc; }, {});
        let streak = 0;
        const today = new Date();
        for (let i = 0; i < 365; i++) {
            const dateToCheck = new Date(today);
            dateToCheck.setDate(today.getDate() - i);
            const dateString = dateToCheck.toISOString().substring(0, 10);
            if (countsByDate[dateString]) { streak++; } else { if (i > 0) break; }
        }
        document.getElementById('streak-counter').innerHTML = `üî• ${streak} ${streak === 1 ? 'dia de ofensiva' : 'dias de ofensiva'}!`;
        const heatmap = document.getElementById('heatmap');
        const monthLabels = document.getElementById('heatmap-months');
        heatmap.innerHTML = ''; monthLabels.innerHTML = '';
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - 120);
        const months = new Map();
        let day = new Date(startDate);
        day.setDate(day.getDate() - day.getDay()); 
        for (let i = 0; i < 121 + startDate.getDay(); i++) {
            const dateString = day.toISOString().substring(0, 10);
            const count = countsByDate[dateString] || 0;
            const dayDiv = document.createElement('div');
            dayDiv.className = 'heatmap-day';
            let level = 0;
            if (count > 0 && count <= 2) level = 1;
            else if (count > 2 && count <= 5) level = 2;
            else if (count > 5 && count <= 8) level = 3;
            else if (count > 8) level = 4;
            dayDiv.dataset.level = level;
            dayDiv.title = `${dateString}: ${count} revis√µes`;
            heatmap.appendChild(dayDiv);
            if (day.getDate() === 1 || i === 0) {
                const monthName = day.toLocaleString('default', { month: 'short' });
                if (!months.has(monthName)) months.set(monthName, 0);
            }
            const currentMonthName = day.toLocaleString('default', { month: 'short' });
            if(months.has(currentMonthName)) { months.set(currentMonthName, months.get(currentMonthName) + 1); }
            day.setDate(day.getDate() + 1);
        }
        let monthBarHtml = '';
        let totalDays = 0;
        for (let [month, days] of months) {
            totalDays += days;
        }
        if (totalDays > 0) {
            for (let [month, days] of months) {
                monthBarHtml += `<span style="flex-grow: ${days}; text-align: center;">${month}</span>`;
            }
        }
        monthLabels.innerHTML = monthBarHtml;
    }
    showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => { el.style.display = 'none'; });
        const screen = document.getElementById(id);
        if (screen) {
            screen.style.display = 'block';
            if (id === 'statistics') this.renderStatistics();
            if (id === 'goals') this.renderGoals();
            if (id === 'manage-disciplines') this.renderManageDisciplinesScreen();
        }
    }
    renderList(element, items, emptyMessage) {
        element.innerHTML = '';
        if (items.length > 0) {
            items.forEach(s => {
                const li = document.createElement('li');
                const disc = this.disciplines.find(d => d.name === s.discipline);
                const prioritySymbol = disc?.weight === 'alta' ? 'üî¥' : disc?.weight === 'media' ? 'üü°' : 'üü¢';
                let text = `${prioritySymbol} ${s.discipline} - ${s.subject}`;
                if (s.history.length > 0) {
                    const lastPerc = s.history.at(-1).percentage;
                    text += ` (${lastPerc}%)`;
                }
                li.innerHTML = text; element.appendChild(li);
            });
        } else { element.innerHTML = `<li>${emptyMessage}</li>`; }
    }
    showEditScreen(subjectId) {
        this.currentEditingId = subjectId;
        const subject = this.subjects.find(s => s.id === subjectId);
        if (!subject) return;
        const disciplineSelect = document.getElementById('edit-discipline-select');
        disciplineSelect.innerHTML = this.disciplines.map(d => `<option value="${d.name}" ${d.name === subject.discipline ? 'selected' : ''}>${d.name}</option>`).join('');
        document.getElementById('edit-subject-input').value = subject.subject;
        document.getElementById('edit-question-bank-link').value = subject.questionBankLink || '';
        this.showScreen('edit-subject');
    }
    saveSubjectChanges() {
        if (!this.currentEditingId) return;
        if (!confirm("Salvar as altera√ß√µes neste assunto?")) return;
        const subjectIndex = this.subjects.findIndex(s => s.id === this.currentEditingId);
        if (subjectIndex === -1) return;
        this.subjects[subjectIndex].discipline = document.getElementById('edit-discipline-select').value;
        this.subjects[subjectIndex].subject = document.getElementById('edit-subject-input').value.toUpperCase();
        this.subjects[subjectIndex].questionBankLink = document.getElementById('edit-question-bank-link').value;
        this.save();
        alert('Assunto atualizado com sucesso!');
        this.showScreen('statistics');
    }
    deleteSubject() {
        if (!this.currentEditingId) return;
        const subject = this.subjects.find(s => s.id === this.currentEditingId);
        if (!subject) return;
        if (confirm(`ATEN√á√ÉO!\n\nVoc√™ tem certeza que deseja excluir o assunto "${subject.subject}"?\n\nTodo o hist√≥rico de revis√µes ser√° perdido permanentemente.`)) {
            if(confirm(`CONFIRMA√á√ÉO FINAL:\n\nExcluir "${subject.subject}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                this.subjects = this.subjects.filter(s => s.id !== this.currentEditingId);
                this.save();
                this.updateDashboard();
                alert('Assunto exclu√≠do com sucesso.');
                this.showScreen('dashboard');
            }
        }
    }
    showHistoryDetail(subjectId) {
        const subject = this.subjects.find(s => s.id === subjectId);
        if (!subject) return;
        document.getElementById('history-detail-title').textContent = `Hist√≥rico de: ${subject.subject}`;
        const contentDiv = document.getElementById('history-detail-content');
        if (subject.history.length === 0) {
            contentDiv.innerHTML = '<p>Nenhuma revis√£o registrada para este assunto.</p>';
        } else {
            let tableHTML = '<table id="history-detail-table"><tr><th>Data</th><th>Desempenho</th><th>Dificuldade</th></tr>';
            [...subject.history].reverse().forEach(h => {
                tableHTML += `
                    <tr>
                        <td>${new Date(h.date).toLocaleDateString('pt-BR')}</td>
                        <td>${h.percentage}%</td>
                        <td>${h.difficulty}</td>
                    </tr>
                `;
            });
            tableHTML += '</table>';
            contentDiv.innerHTML = tableHTML;
        }
        this.showScreen('history-detail');
    }
    renderManageDisciplinesScreen() {
        const listContainer = document.getElementById('discipline-management-list');
        listContainer.innerHTML = '';
        this.disciplines.forEach(d => {
            const hasSubjects = this.subjects.some(s => s.discipline === d.name);
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${d.name}</span>
                <button class="btn btn-small-danger" onclick="deleteDiscipline('${d.name}')" ${hasSubjects ? 'disabled title="Exclua os assuntos desta disciplina primeiro"' : ''}>Excluir</button>
            `;
            listContainer.appendChild(li);
        });
    }
    addDiscipline() {
        const input = document.getElementById('new-discipline-input');
        const newDisciplineName = input.value.trim().toUpperCase();
        if (!newDisciplineName) return alert("O nome da disciplina n√£o pode ser vazio.");
        if (this.disciplines.find(d => d.name.toUpperCase() === newDisciplineName)) return alert("Esta disciplina j√° existe.");
        this.disciplines.push({ name: newDisciplineName, goal: null, weight: 'media' });
        this.disciplines.sort((a, b) => a.name.localeCompare(b.name));
        this.save();
        this.populateDisciplineSelects();
        this.renderManageDisciplinesScreen();
        input.value = '';
        alert(`Disciplina "${newDisciplineName}" adicionada com sucesso!`);
    }
    deleteDiscipline(disciplineName) {
        if (this.subjects.some(s => s.discipline === disciplineName)) {
            alert("N√£o √© poss√≠vel excluir esta disciplina pois existem assuntos cadastrados nela. V√° em 'Estat√≠sticas' para excluir os assuntos primeiro.");
            return;
        }
        if (confirm(`Tem certeza que deseja excluir a disciplina "${disciplineName}"?`)) {
            this.disciplines = this.disciplines.filter(d => d.name !== disciplineName);
            localStorage.removeItem(`discipline-${disciplineName}`);
            this.save();
            this.populateDisciplineSelects();
            this.renderManageDisciplinesScreen();
            alert(`Disciplina "${disciplineName}" exclu√≠da com sucesso.`);
        }
    }
}

function getInitialSubjects() {
    const rawSubjects = {
        'L√çNGUA PORTUGUESA': [
            'Compreens√£o e interpreta√ß√£o de textos de g√™neros variados', 'Reconhecimento de tipos e g√™neros textuais', 'Dom√≠nio da ortografia oficial', 'Mecanismos de coes√£o textual (referencia√ß√£o, conectores, sequencia√ß√£o)', 'Emprego de tempos e modos verbais', 'Emprego das classes de palavras', 'Rela√ß√µes de coordena√ß√£o e subordina√ß√£o entre ora√ß√µes', 'Emprego dos sinais de pontua√ß√£o', 'Concord√¢ncia verbal e nominal', 'Reg√™ncia verbal e nominal', 'Emprego do sinal indicativo de crase', 'Coloca√ß√£o dos pronomes √°tonos', 'Reescrita de frases e par√°grafos (Significa√ß√£o e Substitui√ß√£o)', 'Correspond√™ncia oficial (Manual de Reda√ß√£o da Presid√™ncia)'
        ],
        'MATEM√ÅTICA E RLM': [
            'Modelagem de problemas (equa√ß√µes 1¬∫ e 2¬∫ graus, sistemas lineares)', 'Fun√ß√µes (An√°lise gr√°fica, afim, quadr√°tica, exponencial, logar√≠tmica)', 'Raz√£o, propor√ß√£o e regra de tr√™s', 'Porcentagem', 'Sequ√™ncias num√©ricas (PA e PG)', 'Contagem, probabilidade e estat√≠stica (no√ß√µes b√°sicas)', 'Leitura e interpreta√ß√£o de tabelas e gr√°ficos', 'C√°lculo de m√©dias e an√°lise de desvios', 'Teoria dos conjuntos (no√ß√µes b√°sicas)', 'Figuras planas e espaciais (escalas, proje√ß√µes, planifica√ß√µes)', 'M√©trica (√Åreas e volumes)'
        ],
        'INFORM√ÅTICA': [
            'Conceito de internet e intranet', 'Ferramentas de navega√ß√£o, correio eletr√¥nico, busca e redes sociais', 'No√ß√µes de sistema operacional (Windows)', 'Acesso a dist√¢ncia, transfer√™ncia de arquivos e multim√≠dia', 'Transforma√ß√£o digital (IoT, Big Data, Intelig√™ncia Artificial)', 'Conceitos de prote√ß√£o e seguran√ßa (V√≠rus, Phishing, Pragas virtuais)', 'Aplicativos para seguran√ßa (Antiv√≠rus, Firewall, VPN)', 'Computa√ß√£o na nuvem (Cloud Computing)'
        ],
        'F√çSICA': [
            'Cinem√°tica escalar e vetorial', 'Movimento circular', 'Leis de Newton e suas aplica√ß√µes', 'Trabalho, Pot√™ncia e Energia (cin√©tica e potencial)', 'Conserva√ß√£o de energia e suas transforma√ß√µes', 'Quantidade de movimento, impulso e colis√µes'
        ],
        '√âTICA E CIDADANIA': [
            '√âtica e moral, princ√≠pios e valores', '√âtica na fun√ß√£o e no setor p√∫blico (integridade, moralidade)', 'C√≥digo de √âtica do Servidor P√∫blico (Decreto n¬∫ 1.171/1994)', 'Sistema de Gest√£o da √âtica (Decreto n¬∫ 6.029/2007)', 'Exerc√≠cio da cidadania e democracia', 'Transpar√™ncia e acesso √† informa√ß√£o (Lei n¬∫ 12.527/2011)', 'Conflitos de interesses e nepotismo (Lei n¬∫ 12.813/2013)'
        ],
        'GEOPOL√çTICA': [
            'O Brasil pol√≠tico: na√ß√£o e territ√≥rio', 'Organiza√ß√£o do Estado Brasileiro', 'Divis√£o inter-regional do trabalho e produ√ß√£o no Brasil', 'Estrutura urbana brasileira e metr√≥poles', 'Popula√ß√£o e movimentos migrat√≥rios internos', 'Integra√ß√£o ind√∫stria-urbana-agr√≠cola', 'Rede de transporte no Brasil', 'O Brasil na economia internacional', 'Geografia e gest√£o ambiental', 'Macrodivis√£o natural (biomas, dom√≠nios, ecossistemas)'
        ],
        'L√çNGUA ESPANHOLA': [
            'Compreens√£o de texto escrito em l√≠ngua espanhola', 'Itens gramaticais relevantes para a compreens√£o'
        ],
        'LEGISLA√á√ÉO DE TR√ÇNSITO': [
            'Lei n¬∫ 9.503/1997 (C√≥digo de Tr√¢nsito Brasileiro - CTB)'
        ],
        'DIREITO ADMINISTRATIVO': [
            'Organiza√ß√£o administrativa (Centraliza√ß√£o, Descentraliza√ß√£o, etc.)', 'Ato administrativo (Conceito, requisitos, atributos, etc.)', 'Agentes p√∫blicos (Lei n¬∫ 8.112/1990 e disposi√ß√µes constitucionais)', 'Carreira de Policial Rodovi√°rio Federal (Leis e Decretos)', 'Poderes administrativos (Hier√°rquico, disciplinar, de pol√≠cia, etc.)', 'Licita√ß√£o (Princ√≠pios, modalidades, contrata√ß√£o direta, etc.)', 'Controle da Administra√ß√£o P√∫blica (Administrativo, Judicial, Legislativo)', 'Responsabilidade civil do Estado', 'Regime jur√≠dico-administrativo e seus princ√≠pios'
        ],
        'DIREITO CONSTITUCIONAL': [
            'Poder constituinte (Origin√°rio, Derivado, Reforma, Revis√£o)', 'Direitos e deveres fundamentais (Individuais, coletivos, sociais)', 'Garantias e rem√©dios constitucionais', 'Poder Executivo (Atribui√ß√µes do Presidente, bens e compet√™ncias da Uni√£o)', 'Defesa do Estado e das institui√ß√µes democr√°ticas', 'Seguran√ßa p√∫blica (Art. 144 da CF e atribui√ß√µes da PRF)', 'Ordem social (Seguridade, Meio Ambiente, Fam√≠lia, etc.)'
        ],
        'DIREITO PENAL': [
            'Princ√≠pios b√°sicos e Aplica√ß√£o da lei penal', 'Tipicidade (Dolo, culpa, erro de tipo, consumado, tentado)', 'Ilicitude e causas de exclus√£o', 'Culpabilidade e causas de exclus√£o', 'Crimes contra a pessoa', 'Crimes contra o patrim√¥nio', 'Crimes contra a dignidade sexual', 'Crimes contra a incolumidade e a f√© p√∫blica', 'Crimes contra a Administra√ß√£o P√∫blica'
        ],
        'DIREITO PROCESSUAL PENAL': [
            'A√ß√£o penal (Conceito, esp√©cies, condi√ß√µes)', 'Termo Circunstanciado de Ocorr√™ncia (Lei n¬∫ 9.099/1995)', 'Prova (Conceito, meios de prova, provas il√≠citas)', 'Busca e apreens√£o', 'Pris√£o (Esp√©cies, flagrante, mandado)', 'Identifica√ß√£o Criminal', 'Dilig√™ncias Investigat√≥rias'
        ],
        'LEGISLA√á√ÉO ESPECIAL': [
            'Leis n¬∫ 5.553/68 e 12.037/09 (Identifica√ß√£o)', 'Lei n¬∫ 8.069/90 (Estatuto da Crian√ßa e do Adolescente - ECA)', 'Lei n¬∫ 8.072/90 (Crimes Hediondos)', 'Decreto n¬∫ 1.655/1995 (Transporte Internacional de Cargas)', 'Lei n¬∫ 9.099/95 (Juizados Especiais C√≠veis e Criminais)', 'Lei n¬∫ 9.455/97 (Tortura)', 'Lei n¬∫ 9.605/98 (Crimes Ambientais)', 'Lei n¬∫ 10.826/03 (Estatuto do Desarmamento)', 'Lei n¬∫ 11.343/06 (Lei de Drogas)', 'Lei n¬∫ 12.850/13 (Organiza√ß√µes Criminosas)', 'Lei n¬∫ 13.675/18 (Sistema √önico de Seguran√ßa P√∫blica - SUSP)', 'Lei n¬∫ 13.869/19 (Abuso de Autoridade)'
        ],
        'DIREITOS HUMANOS': [
            'Direitos humanos na Constitui√ß√£o Federal e Tratados Internacionais', 'Declara√ß√£o Universal dos Direitos Humanos', 'Conven√ß√£o Americana sobre Direitos Humanos (Pacto de San Jos√©)'
        ]
    };

    const subjectsArray = [];
    let idCounter = Date.now();
    const today = new Date();

    for (const discipline in rawSubjects) {
        rawSubjects[discipline].forEach(subject => {
            subjectsArray.push({
                id: idCounter++,
                discipline: discipline.toUpperCase(),
                subject: subject.toUpperCase(),
                questionBankLink: '',
                notebook: '',
                reps: 0,
                due: new Date(today),
                history: [],
                interval: 1,
                easeFactor: 2.5
            });
        });
    }
    return subjectsArray;
}

let prf = null;
window.onload = () => {
    prf = new PRFSystem();
};

function showScreen(id) { prf.showScreen(id); }
function addSubject() { prf.addSubject(); }
function startReview() { prf.startReview(); }
function confirmReview(difficulty) { prf.confirmReview(difficulty); }
function saveGoals() { prf.saveGoals(); }
function showHistoryDetail(id) { prf.showHistoryDetail(id); }
function showEditScreen(id) { prf.showEditScreen(id); }
function saveSubjectChanges() { prf.saveSubjectChanges(); }
function deleteSubject() { prf.deleteSubject(); }
function addDiscipline() { prf.addDiscipline(); }
function deleteDiscipline(name) { prf.deleteDiscipline(name); }

// Registro do Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
            .then(registration => { console.log('SW registrado: ', registration.scope); })
            .catch(error => { console.log('SW falhou: ', error); });
    });
}
</script>
</body>
</html>